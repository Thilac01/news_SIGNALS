{% extends "base.html" %}

{% block title %}Location Map{% endblock %}
{% block header_title %}News Location Heatmap{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet Heatmap Plugin CSS -->
<style>
    #map {
        height: calc(100vh - 200px);
        min-height: 500px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .map-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .map-info {
        display: flex;
        gap: 2rem;
        align-items: center;
    }

    .info-item {
        display: flex;
        flex-direction: column;
    }

    .info-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }

    .info-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: white;
    }

    .refresh-btn {
        background: var(--accent);
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .refresh-btn:hover {
        background: var(--accent-hover, #1e88e5);
        transform: translateY(-2px);
    }

    .refresh-btn:disabled {
        background: #555;
        cursor: not-allowed;
        transform: none;
    }

    .legend {
        background: rgba(20, 25, 40, 0.95);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin-top: 1rem;
        max-width: 300px;
    }

    .legend-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: white;
    }

    .legend-scale {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
    }

    .legend-gradient {
        flex: 1;
        height: 20px;
        background: linear-gradient(to right,
                rgba(59, 130, 246, 0.3),
                rgba(6, 182, 212, 0.5),
                rgba(16, 185, 129, 0.7),
                rgba(239, 68, 68, 0.9));
        border-radius: 4px;
    }

    .legend-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 4px;
    }

    .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(20, 25, 40, 0.95);
        padding: 20px 40px;
        border-radius: 8px;
        border: 1px solid var(--border);
        z-index: 1000;
        display: none;
    }

    .loading-overlay.active {
        display: block;
    }

    .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid var(--accent);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Custom Leaflet popup styling */
    .leaflet-popup-content-wrapper {
        background: rgba(20, 25, 40, 0.95);
        color: white;
        border: 1px solid var(--border);
        border-radius: 8px;
    }

    .leaflet-popup-content {
        margin: 12px;
        font-family: 'Outfit', sans-serif;
    }

    .leaflet-popup-tip {
        background: rgba(20, 25, 40, 0.95);
    }

    .location-popup h3 {
        margin: 0 0 8px 0;
        color: var(--accent);
        font-size: 1.1rem;
    }

    .location-popup p {
        margin: 4px 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .location-popup .count {
        color: var(--accent);
        font-weight: 600;
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="map-controls">
    <div class="map-info">
        <div class="info-item">
            <span class="info-label">Total Locations</span>
            <span class="info-value" id="total-locations">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Top Location</span>
            <span class="info-value" id="top-location">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Last Updated</span>
            <span class="info-value" id="last-updated">--</span>
        </div>
    </div>
    <button class="refresh-btn" id="refresh-btn">
        <i class="fa-solid fa-rotate"></i>
        Refresh Data
    </button>
</div>

<div style="position: relative;">
    <div id="map"></div>
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div style="text-align: center; color: white;">Loading location data...</div>
    </div>
</div>

<div class="legend">
    <div class="legend-title">Location Mention Intensity</div>
    <div class="legend-scale">
        <span style="font-size: 0.75rem; color: var(--text-secondary);">Low</span>
        <div class="legend-gradient"></div>
        <span style="font-size: 0.75rem; color: var(--text-secondary);">High</span>
    </div>
    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 10px; margin-bottom: 0;">
        Heatmap shows frequency of location mentions in recent news articles
    </p>
</div>

<!-- News Detail Modal -->
<div id="detail-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 id="modal-title">Location News</h2>
        <div id="modal-body">
            <!-- Content injected by JS -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet Heatmap Plugin -->
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<script>
    let map;
    let heatLayer;
    let markersLayer;
    let locationDataCache = {};

    // Initialize map
    function initMap() {
        // Create map centered on Sri Lanka
        map = L.map('map', {
            zoomControl: true,
            attributionControl: true
        }).setView([7.8731, 80.7718], 8);

        // Dark themed tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // Initialize marker layer group
        markersLayer = L.layerGroup().addTo(map);

        // Load initial data
        loadLocationData();

        // Setup Modal Handlers
        setupModalHandlers();
    }

    // Load location data from API
    async function loadLocationData() {
        const loadingOverlay = document.getElementById('loading');
        const refreshBtn = document.getElementById('refresh-btn');

        try {
            loadingOverlay.classList.add('active');
            refreshBtn.disabled = true;

            const response = await fetch('/api/location-data');
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            updateMapData(data);
            updateStats(data);
            updateLastUpdated();

        } catch (error) {
            console.error('Error loading location data:', error);
            alert('Error loading location data: ' + error.message);
        } finally {
            loadingOverlay.classList.remove('active');
            refreshBtn.disabled = false;
        }
    }

    // Update map with heatmap and markers
    function updateMapData(data) {
        // Clear existing layers
        if (heatLayer) {
            map.removeLayer(heatLayer);
        }
        markersLayer.clearLayers();

        const locations = data.all_locations || {};
        locationDataCache = locations; // Store for modal

        const heatPoints = [];

        // Process location data
        for (const [name, locData] of Object.entries(locations)) {
            if (locData.count > 0) {
                // Add to heatmap (with intensity multiplier for better visualization)
                heatPoints.push([locData.lat, locData.lon, locData.count * 0.5]);

                // Create marker with popup
                const marker = L.circleMarker([locData.lat, locData.lon], {
                    radius: Math.min(8 + Math.log(locData.count) * 2, 15),
                    fillColor: getColorForCount(locData.count),
                    color: '#fff',
                    weight: 1,
                    opacity: 0.8,
                    fillOpacity: 0.6
                });

                // Safe name for onclick string
                const safeName = name.replace(/'/g, "\\'");

                marker.bindPopup(`
                    <div class="location-popup">
                        <h3>${name}</h3>
                        <p>Mentions: <span class="count">${locData.count}</span></p>
                        <button class="view-news-btn" onclick="openLocationModal('${safeName}')" style="
                            background: var(--accent); 
                            color: white; 
                            border: none; 
                            padding: 6px 12px; 
                            border-radius: 4px; 
                            cursor: pointer; 
                            margin-top: 8px;
                            font-size: 0.8rem;
                            width: 100%;
                        ">View News</button>
                    </div>
                `);

                markersLayer.addLayer(marker);
            }
        }

        // Add heatmap layer
        if (heatPoints.length > 0) {
            heatLayer = L.heatLayer(heatPoints, {
                radius: 35,
                blur: 25,
                maxZoom: 10,
                max: 1.0,
                gradient: {
                    0.0: 'rgba(59, 130, 246, 0)',
                    0.2: 'rgba(59, 130, 246, 0.3)',
                    0.4: 'rgba(6, 182, 212, 0.5)',
                    0.6: 'rgba(16, 185, 129, 0.7)',
                    0.8: 'rgba(234, 179, 8, 0.8)',
                    1.0: 'rgba(239, 68, 68, 0.9)'
                }
            }).addTo(map);
        }
    }

    // Get color based on count
    function getColorForCount(count) {
        if (count >= 20) return '#ef4444'; // Red (High risk/activity)
        if (count >= 15) return '#eab308'; // Yellow/Orange
        if (count >= 10) return '#10b981'; // Green
        if (count >= 5) return '#06b6d4'; // Cyan
        return '#3b82f6'; // Blue (Base accent)
    }

    // Update statistics
    function updateStats(data) {
        document.getElementById('total-locations').textContent = data.total_locations || 0;

        if (data.top_locations && data.top_locations.length > 0) {
            const topLoc = data.top_locations[0];
            document.getElementById('top-location').textContent =
                `${topLoc.name} (${topLoc.count})`;
        } else {
            document.getElementById('top-location').textContent = 'N/A';
        }
    }

    // Update last updated timestamp
    function updateLastUpdated() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('last-updated').textContent = timeStr;
    }

    // Refresh button handler
    document.getElementById('refresh-btn').addEventListener('click', async () => {
        await loadLocationData();
    });

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', () => {
        initMap();
    });

    // --- Modal Logic ---

    function setupModalHandlers() {
        const modal = document.getElementById('detail-modal');
        const closeBtn = document.querySelector('.close-modal');

        closeBtn.onclick = function () {
            modal.style.display = "none";
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    }

    // Exposed function to be called from popup
    window.openLocationModal = function (locationName) {
        const modal = document.getElementById('detail-modal');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');

        const locData = locationDataCache[locationName];

        title.innerHTML = `<i class="fa-solid fa-location-dot"></i> News from ${locationName}`;
        body.innerHTML = ''; // Clear previous content

        if (!locData || !locData.news || locData.news.length === 0) {
            body.innerHTML = '<p style="color: var(--text-secondary); padding: 1rem;">No detailed news records found for this location.</p>';
        } else {
            locData.news.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 0.8rem; border: 1px solid var(--border);';

                const dateStr = item.Date ? `<span style="font-size: 0.75rem; color: var(--text-secondary); margin-left: auto;">${item.Date}</span>` : '';

                div.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 0.5rem;">
                        <div style="font-weight: 600; font-size: 1rem; color: var(--text-primary); flex: 1;">${item.Title}</div>
                        ${dateStr}
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem; line-height: 1.5;">${item.Summary || 'No summary available.'}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-muted); padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.05);">
                        <span class="source-badge"><i class="fa-regular fa-newspaper"></i> ${item.Source || 'Unknown Source'}</span>
                        ${item.Link ? `<a href="${item.Link}" target="_blank" style="color: var(--accent); text-decoration: none; display: flex; align-items: center; gap: 4px;">Read Full Article <i class="fa-solid fa-arrow-up-right-from-square" style="font-size: 0.7em;"></i></a>` : ''}
                    </div>
                `;
                body.appendChild(div);
            });
        }

        modal.style.display = "block";
    }
</script>
{% endblock %}